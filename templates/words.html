<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Слова</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins :wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css ">

  <style>
    :root {
      --primary: #6c63ff;
      --primary-light: #a5a1ff;
      --primary-dark: #5a52e0;
      --secondary: #4a4a98;
      --background: #f8f9fe;
      --card-bg: #ffffff;
      --text: #333333;
      --border: #ddd;
      --danger-color: #ff4757;
      --success-color: #2ed573;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.12);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .action-btn { /* Ensured .action-btn is defined for general use */
      display: inline-flex; /* Use inline-flex for proper icon alignment */
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      font-size: 0.85rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none; /* For <a> tags styled as buttons */
      gap: 5px;
      transition: all 0.2s ease;
    }

    .action-btn i {
      font-size: 0.8rem; /* Adjusted for consistency */
    }
    
    .action-btn.btn-primary { /* Specific styling for primary action button */
        background-color: var(--primary);
        color: white;
    }
    .action-btn.btn-primary:hover {
        background-color: var(--primary-dark);
    }

    .action-btn.btn-danger { /* Specific styling for danger action button */
        background-color: var(--danger-color);
        color: white;
    }
    .action-btn.btn-danger:hover {
        background-color: #d63031; /* Darker red for hover */
    }

    /* Стиль для контейнера кнопки добавления слов */
    .add-btn-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }
    
    /* Стиль для круглой кнопки с плюсом */
    .add-btn-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(108, 99, 255, 0.4);
        transition: all 0.3s ease;
    }
    
    .add-btn-circle:hover {
        background-color: var(--primary-dark);
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(108, 99, 255, 0.5);
    }

    .nav-tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .nav-tab {
      flex: 1;
      min-width: 120px;
      padding: 14px 20px;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      color: var(--text);
      background: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .nav-tab.active {
      background: var(--primary);
      color: white;
    }

    .nav-tab:hover:not(.active) {
      background: var(--primary-light);
      color: white;
      transform: translateY(-2px);
    }

    .page-title {
      text-align: center;
      font-size: 2.2rem;
      color: var(--secondary);
      margin-bottom: 30px;
      font-weight: 600;
      position: relative;
    }

    .page-title::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }

    /* Фильтры */
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    select, input[type="text"] {
      padding: 10px 15px;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      /* width: 30%; */ /* Consider adjusting for responsiveness or removing fixed width */
      flex-grow: 1; /* Allow selects to grow */
      min-width: 180px; /* Minimum width for selects */
    }
    

    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .view-toggle button {
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 500;
      background-color: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .view-toggle button.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .view-toggle button:hover {
      background-color: var(--primary-light);
      color: white;
    }

    /* Карточки слов */
    .cards-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Adjusted minmax */
      gap: 20px;
    }

    .word-card {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .word-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .word-text {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--primary);
    }

    .translation {
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 15px;
      flex-grow: 1;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }


    
    .word-actions { /* Defined for consistency with table actions */
      display: flex;
      gap: 8px; /* Spacing between action buttons */
      margin-top: auto; /* Pushes actions to the bottom of the card in flex layout */
    }


    /* Таблица слов */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background-color: white; /* Added background */
      border-radius: 10px; /* Rounded corners for table */
      box-shadow: var(--shadow); /* Shadow for table */
      overflow: hidden; /* Ensures border-radius clips content */
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background-color: var(--primary-light);
      color: white;
      font-weight: 500; /* Adjusted font-weight */
    }
     tr:last-child td { /* Remove border from last row */
        border-bottom: none;
    }

    tr:hover {
      background-color: rgba(108, 99, 255, 0.05);
    }
    
    .add-btn-container {
        text-align: center; /* Center the add button */
        margin-top: 30px;
    }


    @media (max-width: 768px) {
      .nav-tabs {
        flex-direction: column;
      }

      .nav-tab {
        width: 100%;
      }

      .filters {
          flex-direction: column; /* Stack filters vertically */
      }
      .filters select,
      .filters input[type="text"] {
        width: 100%; /* Full width on smaller screens */
      }

      .cards-view {
        grid-template-columns: 1fr; /* Single column on smaller screens */
      }
      .header {
          flex-direction: column;
          align-items: stretch; /* Stretch items like title and button */
      }
      .page-title {
          margin-bottom: 20px; /* Adjust margin */
      }
      .btn {
          width: 100%; /* Make buttons full width if needed */
          margin-bottom: 10px; /* Add some space below buttons */
      }
      .header .btn { /* Specifically target back button in header */
        width: auto; /* Allow back button to size naturally */
        align-self: flex-start; /* Align back button to the start */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="btn btn-primary" id="backButton"><i class="fas fa-arrow-left"></i> Назад</button>
      <h1 class="page-title">Мой словарь</h1>
      </div>

    <div class="nav-tabs">
      <button id="wordsTab" class="nav-tab active"><i class="fas fa-book"></i> Слова</button>
      <button id="testsTab" class="nav-tab"><i class="fas fa-question-circle"></i> Тесты</button>
      <button id="gamesTab" class="nav-tab"><i class="fas fa-gamepad"></i> Игры</button>
    </div>

    <div class="filters">
      <select id="classFilter" onchange="updateUnits()">
        <option value="">Выберите класс</option>
        {% for class_name in items %}
          <option value="{{ class_name }}">{{ class_name }}</option>
        {% endfor %}
      </select>

      <select id="unitFilter" onchange="updateModules()">
        <option value="">Выберите юнит</option>
      </select>

      <select id="moduleFilter" onchange="updateWordsDisplay()">
        <option value="">Выберите модуль</option>
      </select>
    </div>

    <div class="view-toggle">
      <button onclick="setView('cards')" class="active" id="btn-cards">Плитка</button>
      <button onclick="setView('table')" id="btn-table">Таблица</button>
    </div>

    <table id="tableView" style="display: none;">
      <thead>
        <tr>
          <th>Слово</th>
          <th>Перевод</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>

    <div id="cardView" class="cards-view">
      </div>

    <div class="add-btn-container">
      <button id="addWordsButton" class="add-btn-circle"><i class="fas fa-plus"></i></button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js "></script>
  <script>
    // Все слова в виде JSON, передаются из Flask шаблонизатора
    const wordData = {{ items|tojson|safe }};

    const classSelect = document.getElementById("classFilter");
    const unitSelect = document.getElementById("unitFilter");
    const moduleSelect = document.getElementById("moduleFilter");

    const cardView = document.getElementById("cardView");
    const tableView = document.getElementById("tableView");
    const tableBody = document.getElementById("table-body");
    const btnCards = document.getElementById("btn-cards");
    const btnTable = document.getElementById("btn-table");

    function setView(view) {
      if (view === "cards") {
        cardView.style.display = "grid";
        tableView.style.display = "none";
        btnCards.classList.add("active");
        btnTable.classList.remove("active");
      } else { // table view
        cardView.style.display = "none";
        tableView.style.display = "table";
        btnCards.classList.remove("active");
        btnTable.classList.add("active");
      }
    }

    function updateUnits() {
      const selectedClass = classSelect.value;
      unitSelect.innerHTML = '<option value="">Выберите юнит</option>'; // Reset units
      moduleSelect.innerHTML = '<option value="">Выберите модуль</option>'; // Reset modules

      if (selectedClass && wordData[selectedClass]) {
        Object.keys(wordData[selectedClass]).sort().forEach(unit => { // Sort units
          const option = document.createElement("option");
          option.value = unit;
          option.textContent = unit;
          unitSelect.appendChild(option);
        });
      }
      updateWordsDisplay(); // Update word display based on new selections
    }

    function updateModules() {
      const selectedClass = classSelect.value;
      const selectedUnit = unitSelect.value;
      moduleSelect.innerHTML = '<option value="">Выберите модуль</option>'; // Reset modules

      if (selectedClass && selectedUnit && wordData[selectedClass]?.[selectedUnit]) {
        Object.keys(wordData[selectedClass][selectedUnit]).sort().forEach(module => { // Sort modules
          const option = document.createElement("option");
          option.value = module;
          option.textContent = module;
          moduleSelect.appendChild(option);
        });
      }
      updateWordsDisplay(); // Update word display
    }

    function getEditUrl(word, classVal, unitVal, moduleVal, perevod) {
      let baseUrl = `/edit_word/${encodeURIComponent(word)}`;
      // Ensure all params are properly encoded
      let params = new URLSearchParams({
          class: classVal,
          unit: unitVal,
          module: moduleVal,
          perevod: perevod 
      });
      return `${baseUrl}?${params.toString()}`;
    }

    function updateWordsDisplay() {
      const selectedClass = classSelect.value;
      const selectedUnit = unitSelect.value;
      const selectedModule = moduleSelect.value;

      let wordsToShow = [];

      // Iterate through wordData to find words matching the filters,
      // collecting them with their full class, unit, module context.
      for (const classKey in wordData) {
        if (selectedClass && selectedClass !== classKey) continue;
        for (const unitKey in wordData[classKey]) {
          if (selectedUnit && selectedUnit !== unitKey) continue;
          for (const moduleKey in wordData[classKey][unitKey]) {
            if (selectedModule && selectedModule !== moduleKey) continue;
            wordData[classKey][unitKey][moduleKey].forEach(wordPair => {
              if (Array.isArray(wordPair) && wordPair.length === 2) { // Ensure it's a valid word pair
                wordsToShow.push({
                  word: wordPair[0],
                  perevod: wordPair[1],
                  class: classKey,
                  unit: unitKey,
                  module: moduleKey
                });
              }
            });
          }
        }
      }
      
      renderCards(wordsToShow);
      renderTable(wordsToShow);
    }

    function renderCards(words) {
      const container = document.getElementById('cardView');
      container.innerHTML = ''; // Clear existing cards
      
      words.forEach(wordObj => {
        const card = document.createElement('div');
        card.className = 'word-card';
        
        card.innerHTML = `
          <a href="/class/${encodeURIComponent(wordObj.class)}/${encodeURIComponent(wordObj.unit)}/${encodeURIComponent(wordObj.module)}" style="text-decoration: none; color: inherit;">
            <div class="word-text">${wordObj.word}</div>
            <div class="translation">${wordObj.perevod}</div>
          </a>
          <div class="card-actions">
            <a href="${getEditUrl(wordObj.word, wordObj.class, wordObj.unit, wordObj.module, wordObj.perevod)}" class="action-btn btn-primary"><i class="fas fa-edit"></i> Изменить</a>
            <button class="action-btn btn-danger"
                    data-word="${encodeURIComponent(wordObj.word)}"
                    data-class="${encodeURIComponent(wordObj.class)}"
                    data-unit="${encodeURIComponent(wordObj.unit)}"
                    data-module="${encodeURIComponent(wordObj.module)}"
                    onclick="handleDeleteWord(this)">
              <i class="fas fa-trash"></i> Удалить
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderTable(words) {
      const tableBody = document.getElementById('table-body');
      tableBody.innerHTML = ''; // Clear existing rows
      
      words.forEach(wordObj => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td><a href="/class/${encodeURIComponent(wordObj.class)}/${encodeURIComponent(wordObj.unit)}/${encodeURIComponent(wordObj.module)}">${wordObj.word}</a></td>
          <td>${wordObj.perevod}</td>
          <td>
            <a href="${getEditUrl(wordObj.word, wordObj.class, wordObj.unit, wordObj.module, wordObj.perevod)}" class="action-btn btn-primary"><i class="fas fa-edit"></i> Изменить</a>
            <button class="action-btn btn-danger"
                    data-word="${encodeURIComponent(wordObj.word)}"
                    data-class="${encodeURIComponent(wordObj.class)}"
                    data-unit="${encodeURIComponent(wordObj.unit)}"
                    data-module="${encodeURIComponent(wordObj.module)}"
                    onclick="handleDeleteWord(this)">
              <i class="fas fa-trash"></i> Удалить
            </button>
          </td>
        `;
        tableBody.appendChild(row); // Добавляем строку в тело таблицы
      });
    }
    
    function handleDeleteWord(button) {
      const word = decodeURIComponent(button.dataset.word);
      const classVal = decodeURIComponent(button.dataset.class);
      const unitVal = decodeURIComponent(button.dataset.unit);
      const moduleVal = decodeURIComponent(button.dataset.module);

      if (confirm(`Вы уверены, что хотите удалить слово "${word}" (Класс: ${classVal}, Юнит: ${unitVal}, Модуль: ${moduleVal})?`)) {
        fetch(`/delete_word/${encodeURIComponent(word)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                class: classVal,
                unit: unitVal,
                module: moduleVal
                // 'perevod' is not strictly needed for deletion if word, class, unit, module are enough
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Слово "${word}" успешно удалено.`);
                // Update local data and re-render
                updateWordDataAfterDeletion(classVal, unitVal, moduleVal, word);
                updateWordsDisplay(); // Refresh the displayed words
                // Optional: if a filter category becomes empty, update dropdowns
                if (!wordData[classVal]) { // If class was deleted
                    // Remove class from dropdown and re-initialize
                    const classOption = classSelect.querySelector(`option[value="${classVal}"]`);
                    if(classOption) classOption.remove();
                    updateUnits(); // This will also trigger module and word updates
                } else if (!wordData[classVal][unitVal]) { // If unit was deleted
                    updateUnits(); // Re-populate units for current class
                } else if (!wordData[classVal][unitVal][moduleVal]) { // If module was deleted
                    updateModules(); // Re-populate modules for current unit
                }

            } else {
                alert('Ошибка при удалении слова: ' + (data.error || 'Неизвестная ошибка на сервере.'));
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('Произошла сетевая ошибка при попытке удаления слова.');
        });
      }
    }

    function updateWordDataAfterDeletion(classVal, unitVal, moduleVal, wordToDelete) {
        if (wordData[classVal]?.[unitVal]?.[moduleVal]) {
            const wordsInModule = wordData[classVal][unitVal][moduleVal];
            const index = wordsInModule.findIndex(pair => pair[0] === wordToDelete);
            if (index > -1) {
                wordsInModule.splice(index, 1);

                if (wordsInModule.length === 0) {
                    delete wordData[classVal][unitVal][moduleVal];
                    if (Object.keys(wordData[classVal][unitVal]).length === 0) {
                        delete wordData[classVal][unitVal];
                        if (Object.keys(wordData[classVal]).length === 0) {
                            delete wordData[classVal];
                        }
                    }
                }
            }
        }
    }


    window.onload = () => {
      // Initial setup based on URL parameters or defaults
      const urlParams = new URLSearchParams(window.location.search);
      const classParam = urlParams.get('class');
      const unitParam = urlParams.get('unit');
      const moduleParam = urlParams.get('module');
      
      // Populate class filter first, as it's static from initial data
      // (The template already does this with 

      if (classParam && wordData[classParam]) {
        classSelect.value = classParam;
        updateUnits(); // This will populate units and trigger module/word updates
        
        if (unitParam && wordData[classParam][unitParam]) {
          unitSelect.value = unitParam;
          updateModules(); // This will populate modules and trigger word updates
          
          if (moduleParam && wordData[classParam][unitParam][moduleParam]) {
            moduleSelect.value = moduleParam;
            // updateWordsDisplay will be called by updateModules if moduleParam is valid
          }
        }
      } else if (Object.keys(wordData).length > 0) {
        // If no valid params, select the first available class if desired, or leave as "Выберите класс"
        // classSelect.value = Object.keys(wordData).sort()[0]; // Example: select first sorted class
        // updateUnits();
      }
      updateWordsDisplay(); // Initial call to display words based on current (or default) filter selections
      setView('cards'); // Default view
    };

    // Navigation
    document.getElementById("backButton").onclick = () => location.href = '/hello'; // Simplified
    document.getElementById("wordsTab").onclick = () => location.href = '/words';
    document.getElementById("testsTab").onclick = () => location.href = '/tests';
    document.getElementById("gamesTab").onclick = () => location.href = '/games'; // Assuming /games route exists
    document.getElementById("addWordsButton").onclick = () => location.href = '/add_words';
  </script>
</body>
</html>