<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Тест: Диктант</title>

  <!-- Шрифт Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #6c63ff;
      --primary-light: #a5a1ff;
      --primary-dark: #5a52e0;
      --secondary: #4a4a98;
      --background: #f8f9fe;
      --card-bg: #ffffff;
      --text: #333333;
      --border: #ddd;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 10px;
      background: var(--background);
      border-radius: 10px;
    }

    .progress-item {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .progress-item.answered { 
      background: var(--primary-light);
      color: white;
    }

    .progress-item.current {
      border: 2px solid var(--primary);
    }

    .timer {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 20px;
      color: var(--primary);
    }

    .word-card {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background-color: #fff;
    }

    .translation-text {
      font-size: 1.6rem; 
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--secondary);
    }

    .input-label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--text);
      opacity: 0.8;
    }
    
    .word-input {
      width: 100%;
      padding: 12px 15px;
      font-size: 1.1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      margin-bottom: 25px;
      transition: border-color 0.3s ease;
    }

    .word-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .navigation {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }

    .btn {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
    }

    .btn-secondary {
      background-color: var(--background);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>Тест: Диктант</h1>
    </div>

    <div class="timer" id="timer">
      Осталось времени: <span id="time-left">--:--</span>
    </div>

    <div class="progress-bar" id="progress-bar">
      {% for item in words %}
      <div class="progress-item" data-index="{{ loop.index0 }}">
        {{ loop.index }}
      </div>
      {% endfor %}
    </div>

    <form id="test-form" method="POST">
      {% for item in words %}
      {# Assuming item is a tuple (word, perevod) or an object with .word and .perevod #}
      {% set original_word = item[0] if item is iterable and item|length > 0 else item.word %}
      {% set translation = item[1] if item is iterable and item|length > 1 else item.perevod %}
      {% set word_id = loop.index0 %} {# Use loop.index0 as a simple ID if no specific ID is passed #}
      
      <div class="word-card" data-index="{{ loop.index0 }}" style="display: {{ 'block' if loop.index0 == 0 else 'none' }};">
        <div class="translation-text">{{ translation }}</div>
        <label for="answer-{{ word_id }}" class="input-label">Введите слово на языке оригинала:</label>
        <input type="text" 
               class="word-input" 
               name="answer{{ word_id }}" 
               id="answer-{{ word_id }}" 
               autocomplete="off">
      </div>
      {% endfor %}

      <div class="navigation">
        <button type="button" class="btn btn-secondary" id="prev-btn" disabled>
          <i class="fas fa-arrow-left"></i>
          Назад
        </button>
        <button type="button" class="btn btn-primary" id="next-btn">
          Далее
          <i class="fas fa-arrow-right"></i>
        </button>
        <button type="submit" class="btn btn-primary" id="submit-btn" style="display: none;">
          Завершить тест
        </button>
      </div>
    </form>
  </div>

  <script>
    let currentIndex = 0;
    const wordsList = {{ words|tojson }};
    const timeLimit = {{ time_limit|default(0) }};
    let timeLeft = timeLimit > 0 ? timeLimit * 60 : 0;
    let timerInterval;
    const userAnswers = new Array(wordsList.length).fill(''); // Store user answers as strings

    function startTimer() {
      if (timeLimit > 0) {
        updateTimerDisplay();
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        document.getElementById('timer').style.display = 'none';
      }
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      document.getElementById('time-left').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        saveCurrentAnswer(); // Save before submitting
        document.getElementById('test-form').submit();
        return;
      }
      timeLeft--;
      updateTimerDisplay();
    }
    
    function saveCurrentAnswer() {
      const currentInput = document.querySelector(`.word-card[data-index="${currentIndex}"] .word-input`);
      if (currentInput) {
        userAnswers[currentIndex] = currentInput.value;
      }
    }

    function loadAnswer(index) {
      const inputField = document.querySelector(`.word-card[data-index="${index}"] .word-input`);
      if (inputField) {
        inputField.value = userAnswers[index];
      }
    }

    function updateProgressBar() {
      const items = document.querySelectorAll('.progress-item');
      items.forEach((item, index) => {
        item.classList.remove('current', 'answered');
        if (userAnswers[index] !== '') { // Mark as answered if there is any input
          item.classList.add('answered');
        }
        if (index === currentIndex) {
          item.classList.add('current');
        }
      });

      document.getElementById('prev-btn').disabled = currentIndex === 0;
      if (currentIndex === wordsList.length - 1) {
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'inline-flex';
      } else {
        document.getElementById('next-btn').style.display = 'inline-flex';
        document.getElementById('submit-btn').style.display = 'none';
      }
    }

    function showWord(index) {
      saveCurrentAnswer(); // Save answer of the card we are leaving
      document.querySelectorAll('.word-card').forEach(container => {
        container.style.display = 'none';
      });
      const currentContainer = document.querySelector(`.word-card[data-index="${index}"]`);
      if (currentContainer) {
         currentContainer.style.display = 'block';
         const inputField = currentContainer.querySelector('.word-input');
         if(inputField) inputField.focus(); // Auto-focus on the input field
      }
      currentIndex = index;
      loadAnswer(currentIndex); // Load previously saved answer for the new card
      updateProgressBar();
    }

    document.getElementById('prev-btn').addEventListener('click', () => {
      if (currentIndex > 0) {
        showWord(currentIndex - 1);
      }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      // No mandatory check for dictation, user can leave it blank
      if (currentIndex < wordsList.length - 1) {
        showWord(currentIndex + 1);
      } else {
        // If on last card and Next is somehow clicked (should be Submit)
        saveCurrentAnswer();
        updateProgressBar(); // Ensure progress bar is updated
      }
    });

    document.querySelectorAll('.progress-item').forEach(item => {
      item.addEventListener('click', () => {
        const index = parseInt(item.dataset.index);
        showWord(index); // Allow free navigation
      });
    });
    
    // Save answers before submitting the form
    document.getElementById('test-form').addEventListener('submit', (e) => {
      saveCurrentAnswer(); // Save the answer of the very last card
      // Populate all hidden inputs from userAnswers array before actual submission
      // This part is crucial if the server expects individual named inputs per word.
      // If the server processes a single JSON or similar, this might be different.
      wordsList.forEach((word, index) => {
        const inputName = `answer${index}`; // Assuming server expects answer0, answer1, ...
        let hiddenInput = document.querySelector(`input[name="${inputName}"]`);
        if (!hiddenInput) { // If input doesn't exist (e.g. was part of the card), create it
          hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = inputName;
          document.getElementById('test-form').appendChild(hiddenInput);
        }
        hiddenInput.value = userAnswers[index];
      });
      // Optional: Confirmation if not all fields are filled, though for dictation it might be allowed
      const allAnswered = userAnswers.every(answer => answer.trim() !== '');
      if (!allAnswered) {
        if (!confirm('Некоторые поля не заполнены. Вы уверены, что хотите завершить тест?')) {
          e.preventDefault();
          return false;
        }
      }
    });

    // Initial setup
    startTimer();
    showWord(0);
  </script>

</body>
</html>