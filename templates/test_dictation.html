<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Тест: {{ test_title|e }}</title>

  <!-- Шрифт Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #6c63ff;
      --primary-light: #a5a1ff;
      --primary-dark: #5a52e0;
      --secondary: #4a4a98;
      --background: #f8f9fe;
      --card-bg: #ffffff;
      --text: #333333;
      --border: #ddd;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }
     .header h1 {
        color: var(--secondary);
        font-weight: 600;
     }

    .progress-bar-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 30px;
      padding: 10px;
      background: var(--background);
      border-radius: 10px;
    }

    .progress-item {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .progress-item.answered { 
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 500;
    }
    .progress-item.current {
      background-color: var(--primary) !important;
      color: white !important;
      border: 2px solid var(--primary-dark);
      transform: scale(1.1);
    }

    .timer {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 20px;
      color: var(--primary);
    }

    .word-card {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background-color: #fff;
      box-shadow: var(--shadow);
    }

    .translation-text {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--secondary);
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .word-cue-text {
        font-size: 1.5rem;
        font-family: 'Courier New', Courier, monospace;
        color: var(--text);
        margin-bottom: 15px;
        letter-spacing: 2px;
        min-height: 30px;
    }

    .input-label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--text);
      opacity: 0.8;
    }
    
    .word-input {
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      padding: 12px 15px;
      font-size: 1.1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      margin-bottom: 25px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      text-align: center;
    }

    .word-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .navigation {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
    }

    .btn-secondary {
      background-color: var(--background);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background-color: #eee;
      color: #aaa;
    }
    .btn-secondary:disabled {
        background-color: var(--background);
        color: #aaa;
        border-color: #eee;
    }

  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>Тест: {{ test_title|e }}</h1>
    </div>

    <div class="timer" id="timer" style="display: none;">
      Осталось времени: <span id="time-left">--:--</span>
    </div>

    <div class="progress-bar-container" id="progress-bar-container">
      {% for cue, translation, correct_answer_val, tw_id in words_data %}
      <div class="progress-item" data-index="{{ loop.index0 }}">{{ loop.index }}</div>
      {% endfor %}
    </div>

    <form id="test-form" method="POST" action="{{ url_for('test_id', id=test_link_id) }}">
      <input type="hidden" name="test_db_id" value="{{ test_db_id }}">
      {% if not words_data %}
        <p style="text-align:center; color: var(--danger);">Нет слов для этого теста. Обратитесь к учителю.</p>
      {% endif %}
      {% for cue, translation, correct_answer_val, tw_id in words_data %}
      <div class="word-card" data-index="{{ loop.index0 }}" style="display: {{ 'flex' if loop.index0 == 0 else 'none' }}; flex-direction: column; align-items: center;">
        <div class="translation-text">{{ translation }}</div>
        <div class="word-cue-text">{{ cue }}</div>
        <label for="answer-{{ tw_id }}" class="input-label">Введите слово на языке оригинала:</label>
        <input type="text" 
               class="word-input" 
               name="answer{{ tw_id }}"
               id="answer-{{ tw_id }}" 
               autocomplete="off"
               autocorrect="off"
               autocapitalize="none"
               spellcheck="false">
      </div>
      {% endfor %}

      <div class="navigation">
        <button type="button" class="btn btn-secondary" id="prev-btn" disabled>
          <i class="fas fa-arrow-left"></i>
          Назад
        </button>
        <button type="button" class="btn btn-primary" id="next-btn">
          Далее
          <i class="fas fa-arrow-right"></i>
        </button>
        <button type="submit" class="btn btn-primary" id="submit-btn" style="display: none;">
          Завершить тест
        </button>
      </div>
    </form>
  </div>

  <script>
    let currentIndex = 0;
    const wordsData = {{ words_data|tojson|safe }};
    const totalWords = Array.isArray(wordsData) ? wordsData.length : 0;
    const timeLimitInSeconds = {{ time_limit_seconds|default(0) }};
    let timeLeft = timeLimitInSeconds;
    let timerInterval;
    
    const rawAnswers = {{ (current_test_result.answers if current_test_result and current_test_result.answers else '{}')|tojson|safe }};
    let testResultData = {};
    const userAnswers = new Array(totalWords).fill('');

    if (typeof rawAnswers === 'string') {
        try {
            testResultData = JSON.parse(rawAnswers);
        } catch (e) {
            console.error("Error parsing existing answers JSON:", e, "Raw data:", rawAnswers);
            testResultData = {}; 
        }
    } else if (typeof rawAnswers === 'object' && rawAnswers !== null) {
        testResultData = rawAnswers; // Already an object
    }

    if (totalWords > 0 && Object.keys(testResultData).length > 0) {
        wordsData.forEach((wordItem, index) => {
            const testWordId = wordItem[3].toString();
            if (testResultData[testWordId]) {
                userAnswers[index] = testResultData[testWordId];
                const inputField = document.getElementById('answer-' + testWordId);
                if (inputField) {
                    inputField.value = testResultData[testWordId];
                }
            }
        });
    }

    const wordCards = document.querySelectorAll('.word-card');
    const progressItems = document.querySelectorAll('.progress-item');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const submitBtn = document.getElementById('submit-btn');
    const timerDisplay = document.getElementById('time-left');
    const timerContainer = document.getElementById('timer');

    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimer() {
      if (timeLimitInSeconds > 0) {
        timerContainer.style.display = 'block';
        updateTimerDisplay();
        timerInterval = setInterval(() => {
          timeLeft--;
          updateTimerDisplay();
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert('Время вышло!');
            if (document.getElementById('test-form')) document.getElementById('test-form').submit();
          }
        }, 1000);
      } else {
        timerContainer.style.display = 'none';
      }
    }

    function showWord(index) {
      wordCards.forEach((card, i) => {
        card.style.display = (i === index) ? 'flex' : 'none';
      });
      progressItems.forEach((item, i) => {
        item.classList.toggle('current', i === index);
        if (i < totalWords && i < wordsData.length) {
            const testWordIdForProgress = wordsData[i][3];
            const inputForProgress = document.getElementById('answer-' + testWordIdForProgress);
            if (inputForProgress && inputForProgress.value.trim() !== '') {
                item.classList.add('answered');
            } else {
                item.classList.remove('answered');
            }
        }
      });
      prevBtn.disabled = (index === 0);
      nextBtn.style.display = (index === totalWords - 1 || totalWords === 0) ? 'none' : 'inline-flex';
      submitBtn.style.display = (index === totalWords - 1 && totalWords > 0) ? 'inline-flex' : 'none';
      
      if (index < totalWords && index < wordCards.length && wordCards[index]) {
        const currentInput = wordCards[index].querySelector('.word-input');
        if (currentInput) {
            currentInput.focus();
        }
      }
    }

    function saveCurrentAnswer() {
      if (currentIndex < totalWords && currentIndex < wordCards.length && wordCards[currentIndex]) {
        const currentWordData = wordsData[currentIndex];
        const testWordId = currentWordData[3];
        const inputField = document.getElementById('answer-' + testWordId);
        if (inputField) {
          userAnswers[currentIndex] = inputField.value.trim();
          if (currentIndex < progressItems.length) {
            const progressItem = progressItems[currentIndex];
            if (progressItem) {
              if (inputField.value.trim() !== '') {
                  progressItem.classList.add('answered');
              } else {
                  progressItem.classList.remove('answered');
              }
            }
          }
        }
      }
    }
    
    if (totalWords > 0) {
        nextBtn.addEventListener('click', () => {
          saveCurrentAnswer();
          if (currentIndex < totalWords - 1) {
            currentIndex++;
            showWord(currentIndex);
          }
        });

        prevBtn.addEventListener('click', () => {
          saveCurrentAnswer();
          if (currentIndex > 0) {
            currentIndex--;
            showWord(currentIndex);
          }
        });
        
        progressItems.forEach((item, index) => {
            item.addEventListener('click', () => {
                saveCurrentAnswer();
                currentIndex = index;
                showWord(currentIndex);
            });
        });

        document.querySelectorAll('.word-input').forEach((input, index) => {
            input.addEventListener('input', () => {
                if(index < progressItems.length) {
                    const correspondingProgressItem = progressItems[index];
                    if (input.value.trim() !== '') {
                        if(correspondingProgressItem) correspondingProgressItem.classList.add('answered');
                    } else {
                        if(correspondingProgressItem) correspondingProgressItem.classList.remove('answered');
                    }
                }
            });
             input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (currentIndex === totalWords - 1) {
                        submitBtn.click();
                    } else {
                        nextBtn.click();
                    }
                }
            });
        });

        showWord(currentIndex);
        startTimer();
    } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'none';
        timerContainer.style.display = 'none';
        if (document.getElementById('progress-bar-container')) {
             document.getElementById('progress-bar-container').style.display = 'none';
        }
    }

    const testForm = document.getElementById('test-form');
    if (testForm) {
        testForm.addEventListener('submit', function(event) {
            saveCurrentAnswer();
            clearInterval(timerInterval);
            // Display a confirmation dialog
            if (!confirm('Вы точно готовы завершить тест?')) {
                event.preventDefault(); // Prevent form submission if the user cancels
            }
        });
    }

  </script>
</body>
</html>